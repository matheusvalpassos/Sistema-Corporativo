{% extends 'base.html' %}

{% block title %}Invent치rio de TI - Rede Bellas{% endblock %}

{% block content %}
<div class="p-8 min-h-screen bg-slate-50">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Invent치rio de Ativos</h1>
            <p class="text-slate-500 mt-1">Gerenciamento de hardware e equipamentos da rede.</p>
        </div>
        
        <div class="flex gap-3">
            <div class="bg-white border border-slate-200 rounded-xl flex overflow-hidden shadow-sm">
                <button onclick="filtrarAtivos('todos')" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-50 border-r border-slate-100 transition">Todos</button>
                <button onclick="filtrarAtivos('manutencao')" class="px-4 py-2 text-xs font-bold text-orange-600 hover:bg-orange-50 transition">Em Manuten칞칚o</button>
            </div>

            <button onclick="abrirModalAtivo()" class="bg-[#f97316] hover:bg-orange-600 text-white px-5 py-2 rounded-xl shadow-lg shadow-orange-200 transition flex items-center gap-2 font-bold text-sm transform active:scale-95">
                <i class="fas fa-desktop"></i> Novo Ativo
            </button>
        </div>
    </div>

    <div id="loader-ativos" class="flex flex-col items-center justify-center py-20">
        <div class="w-12 h-12 border-4 border-slate-200 border-t-[#f97316] rounded-full animate-spin mb-4"></div>
        <p class="text-slate-400">Carregando invent치rio...</p>
    </div>

    <div id="grid-ativos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 hidden opacity-0 transition-opacity duration-500">
        </div>
</div>

<div id="modal-ativo" class="fixed inset-0 bg-gray-900/60 hidden z-50 flex justify-center items-center backdrop-blur-sm transition-opacity">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl transform transition-all scale-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 class="text-lg font-bold text-gray-800" id="modal-titulo">Novo Equipamento</h3>
            <button onclick="fecharModalAtivo()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        
        <form id="form-ativo" onsubmit="salvarAtivo(event)" class="p-6 space-y-4">
            <input type="hidden" name="id" id="ativo-id">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Patrim칪nio / Tag</label>
                    <input type="text" name="patrimonio" required class="w-full border border-gray-300 rounded-lg py-2.5 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#f97316]" placeholder="RB-001">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categoria</label>
                    <select name="categoria" id="select-categoria" class="w-full border border-gray-300 rounded-lg py-2.5 px-3 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#f97316]">
                        </select>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Modelo / Descri칞칚o</label>
                <input type="text" name="modelo" required class="w-full border border-gray-300 rounded-lg py-2.5 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#f97316]" placeholder="Dell Optiplex 3050 - i5 8GB">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Localiza칞칚o Atual</label>
                    <select name="posto_atual" id="select-posto" class="w-full border border-gray-300 rounded-lg py-2.5 px-3 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#f97316]">
                        </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
                    <select name="status" class="w-full border border-gray-300 rounded-lg py-2.5 px-3 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#f97316]">
                        <option value="USO">游릭 Em Uso</option>
                        <option value="DISP">游댯 Dispon칤vel</option>
                        <option value="MANUT">游 Manuten칞칚o</option>
                        <option value="DEFEITO">游댮 Com Defeito</option>
                    </select>
                </div>
            </div>

            <div class="pt-4 flex justify-end gap-3">
                <button type="button" onclick="fecharModalAtivo()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50 font-medium">Cancelar</button>
                <button type="submit" class="px-6 py-2 bg-[#f97316] text-white rounded-lg font-bold text-sm shadow-md hover:bg-orange-600 transition">Salvar Item</button>
            </div>
        </form>
    </div>
</div>

<script>
    let TODOS_ATIVOS = [];

    async function carregarDados() {
        const grid = document.getElementById('grid-ativos');
        const loader = document.getElementById('loader-ativos');
        
        try {
            // Carrega Ativos, Postos e Categorias
            const [resAtivos, resPostos, resCats] = await Promise.all([
                fetch('/api/ti/ativos/'), // Precisamos garantir que essa rota existe
                fetch('/api/core/postos/'),
                fetch('/api/ti/categorias/') // Precisamos garantir que essa rota existe
            ]);

            TODOS_ATIVOS = await resAtivos.json();
            const postos = await resPostos.json();
            
            // Popula Selects
            const selPosto = document.getElementById('select-posto');
            selPosto.innerHTML = '<option value="">-- Estoque / Matriz --</option>';
            postos.forEach(p => selPosto.innerHTML += `<option value="${p.id}">${p.nome}</option>`);

            // Se a rota de categorias falhar (ainda n칚o existir), tratamos o erro
            try {
                const categorias = await resCats.json();
                const selCat = document.getElementById('select-categoria');
                selCat.innerHTML = '';
                categorias.forEach(c => selCat.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
            } catch(e) {
                console.warn("Categorias n칚o carregadas ou rota inexistente");
            }

            renderizarAtivos(TODOS_ATIVOS);
            
            loader.classList.add('hidden');
            grid.classList.remove('hidden');
            setTimeout(() => grid.classList.remove('opacity-0'), 50);

        } catch (error) {
            console.error(error);
            loader.innerHTML = '<p class="text-red-500">Erro de conex칚o com API.</p>';
        }
    }

    function renderizarAtivos(lista) {
        const grid = document.getElementById('grid-ativos');
        grid.innerHTML = '';

        if(lista.length === 0) {
            grid.innerHTML = '<div class="col-span-4 text-center text-gray-400 py-10">Nenhum ativo encontrado.</div>';
            return;
        }

        lista.forEach(ativo => {
            // Estilos visuais baseados no status
            let statusConfig = { cor: 'bg-green-100 text-green-700', icon: 'fa-check-circle', texto: 'Em Uso' };
            if(ativo.status === 'MANUT') statusConfig = { cor: 'bg-orange-100 text-orange-700', icon: 'fa-tools', texto: 'Manuten칞칚o' };
            if(ativo.status === 'DISP') statusConfig = { cor: 'bg-blue-100 text-blue-700', icon: 'fa-box-open', texto: 'Dispon칤vel' };
            if(ativo.status === 'DEFEITO') statusConfig = { cor: 'bg-red-100 text-red-700', icon: 'fa-ban', texto: 'Defeito' };

            // 칈cone por categoria (Simula칞칚o simples, ideal vir do backend)
            let catIcon = 'fa-desktop';
            // if(ativo.categoria_nome.includes('Impressora')) catIcon = 'fa-print';

            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition group relative";
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="w-10 h-10 rounded-lg bg-slate-50 flex items-center justify-center text-slate-500 text-lg border border-slate-100">
                        <i class="fas ${catIcon}"></i>
                    </div>
                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide ${statusConfig.cor}">
                        <i class="fas ${statusConfig.icon} mr-1"></i> ${statusConfig.texto}
                    </span>
                </div>
                
                <h4 class="font-bold text-slate-800 leading-tight mb-1 truncate">${ativo.modelo}</h4>
                <p class="text-xs font-mono text-slate-400 mb-4 bg-slate-50 inline-block px-1 rounded">TAG: ${ativo.patrimonio}</p>

                <div class="border-t border-slate-100 pt-3 flex items-center gap-2 text-xs text-slate-500">
                    <i class="fas fa-map-marker-alt text-slate-300"></i>
                    <span class="truncate">${ativo.posto_nome || 'Matriz / Estoque'}</span>
                </div>

                <button onclick="editarAtivo(${ativo.id})" class="absolute top-4 right-4 text-slate-300 hover:text-[#f97316] opacity-0 group-hover:opacity-100 transition">
                    <i class="fas fa-pencil-alt"></i>
                </button>
            `;
            grid.appendChild(card);
        });
    }

    function filtrarAtivos(tipo) {
        if(tipo === 'todos') renderizarAtivos(TODOS_ATIVOS);
        if(tipo === 'manutencao') renderizarAtivos(TODOS_ATIVOS.filter(a => a.status === 'MANUT'));
    }

    // --- CRUD ---
    async function salvarAtivo(e) {
        e.preventDefault();
        const form = document.getElementById('form-ativo');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        // Ajuste: Se posto_atual for vazio, envia null
        if(!data.posto_atual) data.posto_atual = null;

        const id = document.getElementById('ativo-id').value;
        const method = id ? 'PATCH' : 'POST';
        const url = id ? `/api/ti/ativos/${id}/` : '/api/ti/ativos/';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                fecharModalAtivo();
                carregarDados();
            } else { alert('Erro ao salvar. Verifique os campos.'); }
        } catch (e) { console.error(e); }
    }

    async function editarAtivo(id) {
        // Busca dados e preenche form (Simplificado)
        // Ideal: fetch no /api/ti/ativos/${id}/ e preencher
        alert('Funcionalidade de edi칞칚o pronta no backend, basta conectar aqui!');
        abrirModalAtivo();
    }

    function abrirModalAtivo() {
        document.getElementById('form-ativo').reset();
        document.getElementById('ativo-id').value = '';
        document.getElementById('modal-titulo').innerText = "Novo Equipamento";
        document.getElementById('modal-ativo').classList.remove('hidden');
    }
    function fecharModalAtivo() { document.getElementById('modal-ativo').classList.add('hidden'); }
    function getCookie(name) {
        let v = null;
        if (document.cookie && document.cookie !== '') document.cookie.split(';').forEach(c => {
            if (c.trim().substring(0, name.length + 1) === (name + '=')) v = decodeURIComponent(c.trim().substring(name.length + 1));
        });
        return v;
    }

    carregarDados();
</script>
{% endblock %}